<!doctype html>
<html lang="zh" class="h-100">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/style.css">

    <title>€šè®¯.md</title>
  </head>
  <body class="h-100">
  <div class="container-fluid h-100 p-2">
  	<h3>é›†ç¾¤æ¶æ„:åˆ†å¸ƒå¼è¿›ç¨‹é€šè®¯</h3><p>å¦‚æœbeyodæ˜¯ä»¥å¤šè¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œä¸åŒçš„å®¢æˆ·ç«¯ä¼šè¿æ¥åˆ°ä¸åŒçš„å·¥ä½œè¿›ç¨‹ä¸Šï¼Œå› ä¸ºè¿™äº›å·¥ä½œå±äºä¸åŒçš„åœ°å€ç©ºé—´ï¼Œå®ƒä»¬ä¹‹é—´æ— æ³•ç›´æ¥é€šè®¯ï¼Œå¿…é¡»å€ŸåŠ©ä¸€äº›å…±äº«é€šé“ï¼ˆå¦‚ä¿¡å·ã€unix domain socketã€æ¶ˆæ¯é˜Ÿåˆ—ã€socketç­‰ï¼‰æ‰èƒ½é€šè®¯ã€‚</p><p>beyodå¼€å‘ä¹‹åˆï¼Œå°±å……åˆ†è€ƒè™‘åˆ°åˆ†å¸ƒå¼åº”ç”¨ç¯å¢ƒï¼Œä¸ºæ­¤å†…ç½®äº†è®¢é˜…å‘å¸ƒæ¨¡å‹çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯ç»„ä»¶ï¼Œ å¯ä»¥å¾ˆå®¹æ˜“æ„å»ºè·¨æœåŠ¡å™¨çš„åˆ†å¸ƒå¼åº”ç”¨æ¶æ„ã€‚ </p><p>ä¸ºäº†æ”¯æŒåˆ†å¸ƒå¼æ¶ˆæ¯é€šè®¯ï¼ŒåŒæ—¶å¼•å…¥äº†ä¸€äº›æ¦‚å¿µï¼Œéœ€è¦é¢„å…ˆæ·±å…¥äº†è§£ï¼š</p><h4>server_id</h4><p>æ¯ä¸ªbeyod serverå®ä¾‹çš„å”¯ä¸€id, é»˜è®¤ä¸º1ï¼Œ ä¸åŒçš„beyod serverå®ä¾‹ï¼Œå¿…é¡»ä¸èƒ½ç›¸åŒã€‚å–å€¼èŒƒå›´1~65535ã€‚åº”è¯¥ä¸ºserverç»„ä»¶é…ç½®å…¶server_id:  <br>config/main.php</p><pre><code>'components'=&gt;[
    'server' =&gt; [
        'class' =&gt; 'beyoio\Server',
        'server_id' =&gt; 174,
        //...
    ]
]</code></pre><h4>worker_id</h4><p>å·¥ä½œè¿›ç¨‹çš„ç¼–å·ï¼Œè¿™æ˜¯ä¸€ä¸ªåªè¯»å±æ€§ï¼Œè¡¨ç¤ºå·¥ä½œè¿›ç¨‹çš„é¡ºåºå·ï¼Œä»1å¼€å§‹é€’å¢ã€‚<br>==å¦‚æœä¸€ä¸ªè¿›ç¨‹å´©æºƒåè¢«ä¸»è¿›ç¨‹é‡æ–°ç”Ÿæˆåï¼Œworker_idæ˜¯ä¸å˜çš„==ã€‚æˆ‘ä»¬å¯ä»¥æ ¹æ®worker_idå®ç°è¿›ç¨‹åŒºåˆ«å’Œæ ‡è¯†ã€‚  </p><p>è¿è¡Œæ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å–å¾—å½“å‰å·¥ä½œè¿›ç¨‹çš„workder_id:</p><pre><code>$worker_id = \Yii::$app-&gt;server-&gt;getWorkerId();</code></pre><h4>GPID</h4><p>å…¨å±€è¿›ç¨‹å”¯ä¸€æ ‡è¯†(Global process unique identification)</p><p>å³å·¥ä½œè¿›ç¨‹åœ¨æ•´ä¸ªé›†ç¾¤ä¸­çš„å…¨å±€å”¯ä¸€æ ‡è¯†ï¼Œç®—æ³•ä¸ºï¼š</p><pre><code>$GPID = ($server_id &lt;&lt; 16) + $worker_id;</code></pre><p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹å¼å–å¾—å½“å‰è¿›ç¨‹åœ¨é›†ç¾¤ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼š</p><pre><code>$gpid = \Yii::$app-&gt;server-&gt;getGPID();</code></pre><p>å…¸å‹çš„ï¼Œåœ¨beyodçš„åˆ†å¸ƒå¼æ¶ˆæ¯æ¨é€æ¶æ„ä¸­ï¼ŒGPIDä½œä¸ºé¢‘é“åç§°ä½¿ç”¨ã€‚</p><h4>dispatcher</h4><p>åˆ†å‘å™¨ï¼Œbeyodå†…å»ºäº†åˆ†å¸ƒå¼æ¶ˆæ¯æ¨é€æœåŠ¡å™¨ç»„ä»¶ï¼Œå®ƒçš„ä½œç”¨ï¼š</p><ol><li>æ¥å—å®¢æˆ·ç«¯çš„è®¢é˜…è¯·æ±‚</li><li>æ¥æ”¶å®¢æˆ·ç«¯çš„å‘å¸ƒè¯·æ±‚ï¼Œæ ¹æ®é¢‘é“å·ï¼Œå°†æ¶ˆæ¯æ¨é€åˆ°ç›¸å…³è®¢é˜…è€…ã€‚</li><li>æ”¯æŒå¤šç§æ•°æ®ç»“æ„ï¼š</li></ol><p><strong>å‘å¸ƒè®¢é˜…æ¨¡å‹</strong>  <br><strong>hashè¡¨å…±äº«å­˜å‚¨</strong>  <br><strong>åŸºäºSplMaxHeapçš„ä¼˜å…ˆé˜Ÿåˆ—</strong>  <br><strong>æ¶ˆæ¯å¹¿æ’­</strong>  </p><p>dispatcherä½¿ç”¨å†…å­˜å­˜å‚¨hash/é˜Ÿåˆ—æ•°æ®ï¼Œè§„åˆ’å‰è¦è€ƒè™‘åˆ°å†…å­˜å®¹é‡é™åˆ¶çš„é—®é¢˜ã€‚ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ•°æ®åº“/ç¼“å­˜ç³»ç»Ÿ/é˜Ÿåˆ—ç³»ç»Ÿæ¥å­˜å‚¨æ•°æ®ã€‚dispatcheræœ€é€‚åˆçš„å°±åœºæ™¯å°±æ˜¯åˆ†å‘æ¶ˆæ¯è€Œä¸æ˜¯å­˜å‚¨æ•°æ®ã€‚</p><p>è€ƒè™‘åˆ°dipatch serverä»…ä»…åªæ˜¯è½¬å‘æ¶ˆæ¯ï¼Œå¹¶ä¸å‚ä¸å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œå®ƒæœ¬èº«å³ä¾¿ä»¥å•è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œä¹Ÿå¾ˆéš¾å½¢æˆç“¶é¢ˆã€‚å¦‚æœä¸šåŠ¡é‡è¾ƒå¤§ï¼Œå•ä¸ªdispatcher serveræ— æ³•æ”¯æŒï¼Œé‚£ä¹ˆå®Œå…¨å¯ä»¥éƒ¨ç½²å¤šä¸ªdispatcherï¼Œå®ç°è´Ÿè½½å‡è¡¡æ¶æ„ã€‚</p><p><strong>dispatcher serverçš„é…ç½®</strong>  <br>config/main.php</p><pre><code>'components'=&gt;[
    'server'=&gt;[
        'class' =&gt; 'beyoio\Server',
        'worker_num'=&gt;1, //ä»¥å•è¿›ç¨‹æ–¹å¼è¿è¡Œï¼Œä¿è¯æ•°æ®æ˜¯å…±äº«å”¯ä¸€çš„
        'listeners' =&gt; [
            'class' =&gt; 'beyoio\Listener',
            'listen'=&gt;'tcp://0.0.0.0:2491'
            'handler'=&gt;'beyoio\dispatcher\Handler',
            'parser' =&gt;'beyoio\dispatcher\Parser'
        ],
    ]
]</code></pre><p><strong>å®¢æˆ·ç«¯</strong>  <br>ä¾‹å¦‚ï¼šæˆ‘ä»¬å¯ä»¥åœ¨workerå¯åŠ¨ä¹‹åï¼Œå°±è®¢é˜…é¢‘é“å¹¶å‡†æ¶ˆæ¯çš„æ¥æ”¶å¤„ç†(å‡è®¾dispatcherçš„ipä¸º192.168.0.101)ï¼š  <br>appMyServer.phpä¸­çš„å†…å®¹ï¼š</p><pre><code>namespace app;

use beyoio\Server;
use beyoio\dispatcher\Client;

class MyServer extends Server
{
    public $client;
    
    //æ­¤å›è°ƒåœ¨å·¥ä½œè¿›ç¨‹å¯åŠ¨åæ‰§è¡Œ
    public function onWorkerStart($workerId, $GPID)
    {
        parent::onWorkerStart($workerId, $GPID);
        $this-&gt;connectDispatcher($GPID);
    }
    
    
    /**
     * è¿æ¥è®¢é˜…æœåŠ¡å™¨
     */
    protected function connectDispatcher()
    {
        $options = [
            'target' =&gt; 'tcp://192.168.0.101:2491',
            'reconnect_interval' =&gt; 6, //è¿æ¥è¢«å¯¹æ–¹æ–­å¼€åï¼Œ6ç§’åé‡è¿ã€‚
        ];
        
        $this-&gt;client = new Client($options);
        $this-&gt;client-&gt;default_channel=$this-&gt;getGpid();//è¿æ¥æˆåŠŸåï¼Œå³è®¢é˜…é¢‘é“ï¼Œé¢‘é“å·å³ä¸ºGPID
        
        
        $this-&gt;client-&gt;on(Server::ON_MESSAGE, function(MessageEvent $event){
            print_r($event-&gt;message); //æ”¶åˆ°æ¶ˆæ¯æ—¶çš„å›è°ƒ
        });
        
        //è¿æ¥åˆ°åˆ†å‘æœåŠ¡å™¨ã€‚
        $this-&gt;client-&gt;connect();
    }
}
</code></pre><p><strong>beyoiodispatcherClient</strong></p><p>beyoiodispatcherClientåˆ†å‘å™¨å®¢æˆ·ç«¯è¿æ¥ç»„ä»¶ï¼š</p><pre><code>&lt;?php

namespace beyoio\dispatcher;

use beyoio\StreamClient;
use beyoio\Server;
use beyoio\IOEvent;

class Client extends StreamClient
{

    public $reconnect_interval = 3; //è¿æ¥å¼‚å¸¸ä¸­æ–­åçš„é‡è¿é—´éš”3ç§’
    
    //è¿æ¥åè‡ªåŠ¨è®¢é˜…çš„é¢‘é“
    public $default_channel = [];
    
    /**
     * è®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“
     * @param array|string $keys The channel names to subscribe to
     */
    public function subscribe($keys)
    {
        return $this-&gt;send(['command'=&gt;'subscribe', 'key'=&gt;$keys, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * å–æ¶ˆè®¢é˜…ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“
     * @param array|string $keys The channel names to cancel
     */
    public function unsubscribe($keys)
    {
        return $this-&gt;send(['command'=&gt;'unsubscribe', 'key'=&gt;$keys, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * å‘ä¸€ä¸ªæˆ–å¤šä¸ªé¢‘é“ä¸Šæ¨é€æ¶ˆæ¯
     * @param string|array $key
     * @param mixed $value
     */
    public function publish($key, $value)
    {
        return $this-&gt;send(['command'=&gt;'publish', 'key'=&gt;$keys, 'value'=&gt;$value, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * å‘æ‰€æœ‰é¢‘é“å¹¿æ’­æ¶ˆæ¯
     * @param mixed $value
     */
    public function broadcat($value)
    {
        return $this-&gt;send(['command'=&gt;'broadcat','value'=&gt;$value, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    
    /**
     * è·å–å·²ç»è®¢é˜…çš„é¢‘é“é›†åˆ
     */
    public function channels()
    {
        $this-&gt;send(['command' =&gt; 'channels', 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    
    /**
     * è®¾ç½®ä¸€ä¸ªhashè¡¨æ¡ç›®
     * @param string $key
     * @param mixed $value
     * @param int $expire ç¼“å­˜è¿‡æœŸç»å¯¹æ—¶é—´æˆ³ 0è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ
     */
    public function set($key, $value, $expire=0)
    {
        return $this-&gt;send(['command'=&gt;'set', 'key'=&gt;$key, 'value'=&gt;$value, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * è¯»å–ä¸€ä¸ªhashè¡¨æ¡ç›®
     * @param string $key
     */
    public function get($key)
    {
        return $this-&gt;send(['command'=&gt;'get', 'key'=&gt;$key, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * åˆ é™¤ä¸€ä¸ªhashè¡¨æ¡ç›®
     * @param string $key
     */    
    public function delete($key)
    {
        return $this-&gt;send(['command'=&gt;'delete', 'key'=&gt;$key, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    //åˆ é™¤æ‰€æœ‰hashæ¡ç›®
    public function deleteAll()
    {
        return $this-&gt;send(['command'=&gt;'deleteall','seq'=&gt;$this-&gt;getSequence()]);
    }
    
    
    /**
     * å‘é˜Ÿåˆ—ä¸­è¿½åŠ è®°å½•
     * @param string $key queue name
     * @param mixed $value data
     * @param int $priority 
     * @see http://php.net/manual/en/splpriorityqueue.insert.php
     */
    public function qpush($key, $value)
    {
        return $this-&gt;send(['command'=&gt;'qpush', 'key'=&gt;$key,'value'=&gt;$value, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * ä»é˜Ÿåˆ—ä¸­å–å‡ºè®°å½•
     * @param string $key queue name
     * @param string $block whether enable blocking mode. In blocking mode, the server returns only if there is data in the queue
     * @return void|boolean|number
     */
    public function qpop($key, $block=false){
        return $this-&gt;send(['command'=&gt;'qpop', 'key'=&gt;$key, 'block'=&gt;$block, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * æ¸…ç©ºæŒ‡å®šé˜Ÿåˆ—
     * @param string $key queue name
     */
    public function qdelete($key)
    {
        return $this-&gt;send(['command'=&gt;'qdelete', 'key'=&gt;$key, 'seq'=&gt;$this-&gt;getSequence()]);
    }
    
    /**
     * æ¸…ç©ºæ‰€æœ‰é˜Ÿåˆ—
     * @param string $key queue name
     */
    public function qdeleteAll($key)
    {
        return $this-&gt;send(['command'=&gt;'qdeleteall', 'key'=&gt;$key, 'seq'=&gt;$this-&gt;getSequence()]);
    }
}</code></pre><p><strong>åè®®æ ¼å¼</strong><br>dispatcheræ¶ˆæ¯ä½¿ç”¨äºŒè¿›åˆ¶jsonæ ¼å¼ï¼Œç”±åŒ…å¤´å’Œæ•°æ®éƒ¨åˆ†ç»„æˆã€‚ä½¿ç”¨jsonæ ¼å¼è€Œä¸æ˜¯PHPåºåˆ—åŒ–ï¼Œå°±å¾ˆå®¹æ˜“å…¼å®¹å¤šç§ç¼–ç¨‹è¯­è¨€ã€‚ <br>åŒ…å¤´æ˜¯ä¸€ä¸ª4å­—èŠ‚æ— ç¬¦å·çš„æ•´æ•°ï¼ŒæŒ‡æ˜äº†æ•´ä¸ªæ•°æ®åŒ…çš„é•¿åº¦ï¼Œæ•°æ®éƒ¨åˆ†å³jsonå­—ç¬¦ä¸²ã€‚ä»¥ä¸‹æè¿°ä¸­ï¼Œçœå»åŒ…å¤´éƒ¨åˆ†ï¼Œç€é‡å…³æ³¨æ•°æ®éƒ¨åˆ†ï¼š</p><ol><li>è®¢é˜…è¯·æ±‚</li></ol><p>{"command":"subscribe", "key": [], "seq":""}</p><pre><code>key:æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼ŒæŒ‡å®šäº†è¦è®¢é˜…çš„é¢‘é“    
seq:å½“å‰æ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ï¼Œç”±clientè‡ªåŠ¨ç”Ÿæˆã€‚   </code></pre><p>å“åº”ç»“æœï¼š <br>{"command":"subscribe","key":[], "code":0,"message":"ok", "seq":""}</p><ol><li>å–æ¶ˆè®¢é˜…ï¼š</li></ol><p>{"command":"unsubscribe", "key": [], "seq":""} <br>å“åº”ç»“æœï¼š  <br>{"command":"unsubscribe","key":[], "code":0,"message":"ok", "seq":""}</p><ol><li>å‘å¸ƒæ¶ˆæ¯</li></ol><p>{"command":"publish", "key": [],"value": "", "seq":""}    <br>valueå³ä¸ºæ¶ˆæ¯å†…å®¹  <br>å“åº”ç»“æœï¼š  <br>{"command":"publish", "key": [],"value": "", "seq":""}</p><ol><li>é¢‘é“æ¶ˆæ¯ç»“æ„ï¼š</li></ol><p>{"command":"message", "value":"", "source":"æ¶ˆæ¯å‘é€è€…çš„ipå’Œç«¯å£"}</p>  </div>
  <script src="assets/js/jquery.min.js"></script>
  <script src="assets/js/popper.min.js"></script>
  <script src="assets/js/bootstrap.min.js"></script>

<script>
$(function(){
  var url = self.location;
  parent.$('a').removeClass('font-weight-bold');
  parent.$('a[href="24.html"]').addClass('font-weight-bold');
});
</script>  
  
  </body>
</html>